<UserControl x:Class="DCM.App.Views.LlmSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ap="clr-namespace:DCM.App.Infrastructure.AttachedProperties"
             xmlns:sys="clr-namespace:System;assembly=mscorlib">
  <UserControl.Resources>
    <x:Array x:Key="SuggestionCountOptions"
             Type="{x:Type sys:Int32}">
      <sys:Int32>1</sys:Int32>
      <sys:Int32>2</sys:Int32>
      <sys:Int32>3</sys:Int32>
      <sys:Int32>4</sys:Int32>
      <sys:Int32>5</sys:Int32>
    </x:Array>
  </UserControl.Resources>
  <Grid Margin="{StaticResource ViewRootMargin}">
    <Grid.RowDefinitions>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <ScrollViewer Grid.Row="0"
                  VerticalScrollBarVisibility="Auto">
      <Grid HorizontalAlignment="Left"
            MaxWidth="{StaticResource SettingsContentMaxWidth}"
            VerticalAlignment="Top">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"
                            MinWidth="{StaticResource SettingsColumnMinWidth}"/>
          <ColumnDefinition Width="{StaticResource SpacingXXL}"/>
          <ColumnDefinition Width="*"
                            MinWidth="{StaticResource SettingsColumnMinWidth}"/>
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="{StaticResource SpacingXL}"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <GroupBox Grid.Row="0"
                    Style="{StaticResource SettingsSectionGroupBox}">
            <GroupBox.Header>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{DynamicResource Settings.LLM.Mode}" VerticalAlignment="Center"/>
                <Border Grid.Column="1" Style="{StaticResource HelpIconButton}"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmMode.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </Grid>
            </GroupBox.Header>
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- 0: Mode ComboBox -->
                <RowDefinition Height="Auto"/> <!-- 1: Preset Label -->
                <RowDefinition Height="Auto"/> <!-- 2: Preset ComboBox + Download -->
                <RowDefinition Height="Auto"/> <!-- 3: Download Progress -->
                <RowDefinition Height="Auto"/> <!-- 4: Custom Path Label -->
                <RowDefinition Height="Auto"/> <!-- 5: Custom Path TextBox -->
                <RowDefinition Height="Auto"/> <!-- 6: Model Type Label -->
                <RowDefinition Height="Auto"/> <!-- 7: Model Type ComboBox -->
                <RowDefinition Height="Auto"/> <!-- 8: System Prompt Label -->
                <RowDefinition Height="Auto"/> <!-- 9: System Prompt TextBox -->
                <RowDefinition Height="Auto"/> <!-- 10: Status -->
              </Grid.RowDefinitions>
              <ComboBox Grid.Row="0"
                        x:Name="LlmModeComboBox"
                        MinWidth="{StaticResource InputMinWidthM}"
                        SelectionChanged="LlmModeComboBox_SelectionChanged">
                <ComboBoxItem Content="{DynamicResource Settings.LLM.Off}"
                              Tag="Off"/>
                <ComboBoxItem Content="{DynamicResource Settings.LLM.Local}"
                              Tag="Local"/>
              </ComboBox>

              <!-- Model Preset Selection -->
              <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="{StaticResource LabelMarginTop}">
                <TextBlock Text="{DynamicResource Settings.LLM.ModelPreset}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmModel.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <Grid Grid.Row="2"
                    Margin="{StaticResource LabelMarginBottom}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <ComboBox x:Name="LlmModelPresetComboBox"
                          Grid.Column="0"
                          MinWidth="{StaticResource InputMinWidthM}"
                          SelectionChanged="LlmModelPresetComboBox_SelectionChanged">
                  <ComboBoxItem Content="{DynamicResource Settings.LLM.ModelPreset.Phi3Mini}"
                                Tag="Phi3Mini4kQ4"/>
                  <ComboBoxItem Content="{DynamicResource Settings.LLM.ModelPreset.Custom}"
                                Tag="Custom"/>
                </ComboBox>
                <Button x:Name="LlmModelDownloadButton"
                        Grid.Column="1"
                        Content="{DynamicResource Settings.LLM.Download}"
                        Style="{StaticResource SecondaryButton}"
                        ap:ButtonIcon.Glyph="&#xe2c4;"
                        Margin="8,0,0,0"
                        Click="LlmModelDownloadButton_Click"/>
              </Grid>

              <!-- Download Progress -->
              <Grid Grid.Row="3"
                    x:Name="LlmDownloadProgressPanel"
                    Visibility="Collapsed"
                    Margin="{StaticResource LabelMarginBottom}">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <ProgressBar Grid.Row="0"
                             x:Name="LlmDownloadProgressBar"
                             Height="{StaticResource ProgressBarHeight}"
                             Minimum="0"
                             Maximum="100"
                             Value="0"/>
                <TextBlock Grid.Row="1"
                           x:Name="LlmDownloadProgressText"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"
                           Margin="{StaticResource LabelMarginTopSmall}"/>
              </Grid>

              <!-- Custom Model Path (only visible when Custom is selected) -->
              <StackPanel Grid.Row="4" x:Name="LlmCustomPathLabel" Orientation="Horizontal" Margin="{StaticResource LabelMarginTop}" Visibility="Collapsed">
                <TextBlock Text="{DynamicResource Settings.LLM.PathToModel}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmModelPath.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <Grid Grid.Row="5"
                    x:Name="LlmCustomPathPanel"
                    Visibility="Collapsed"
                    Margin="{StaticResource LabelMarginBottom}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="LlmModelPathTextBox"
                         Grid.Column="0"
                         MinWidth="{StaticResource InputMinWidthXL}"
                         HorizontalAlignment="Stretch"
                         ToolTip="{DynamicResource Settings.LLM.PathToModel.Tooltip}"
                         TextChanged="OnSettingChanged"/>
                <Button x:Name="LlmModelPathBrowseButton"
                        Grid.Column="1"
                        Content="{DynamicResource Settings.ChoosePath}"
                        Style="{StaticResource SecondaryButton}"
                        ap:ButtonIcon.Glyph="&#xe2c8;"
                        Margin="8,0,0,0"
                        Click="LlmModelPathBrowseButton_Click"/>
              </Grid>

              <!-- Model Type (only for Custom) -->
              <StackPanel Grid.Row="6" x:Name="LlmModelTypeLabel" Orientation="Horizontal" Margin="{StaticResource LabelMarginTop}" Visibility="Collapsed">
                <TextBlock Text="{DynamicResource Settings.LLM.ModelType}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmModelType.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <ComboBox Grid.Row="7"
                        x:Name="LlmModelTypeComboBox"
                        MinWidth="{StaticResource InputMinWidthM}"
                        Visibility="Collapsed"
                        SelectionChanged="OnComboBoxSettingChanged">
                <ComboBoxItem Content="{DynamicResource Settings.LLM.ModelType.Detect}"
                              Tag="Auto"
                              IsSelected="True"/>
                <ComboBoxItem Content="{DynamicResource Settings.LLM.ModelType.Phi3}"
                              Tag="Phi3"/>
                <ComboBoxItem Content="{DynamicResource Settings.LLM.ModelType.Mistral3}"
                              Tag="Mistral3"/>
              </ComboBox>

              <TextBlock Grid.Row="8"
                         Text="{DynamicResource Settings.LLM.SystemPrompt}"
                         FontSize="{StaticResource FontSizeS}"
                         Foreground="{StaticResource TextMutedBrush}"
                         Margin="{StaticResource LabelMarginTop}"/>
              <TextBox Grid.Row="9"
                       x:Name="LlmSystemPromptTextBox"
                       AcceptsReturn="True"
                       Height="80"
                       TextWrapping="Wrap"
                       VerticalScrollBarVisibility="Auto"
                       TextChanged="OnSettingChanged"/>

              <Grid Grid.Row="10"
                    Margin="{StaticResource LabelMarginTop}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0"
                           Text="{DynamicResource Common.Status}"
                           Foreground="{StaticResource TextMutedBrush}"
                           Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1"
                           x:Name="LlmStatusTextBlock"
                           Text="{DynamicResource Settings.LLM.Status}"
                           Foreground="{StaticResource TextMutedBrush}"/>
              </Grid>
            </Grid>
          </GroupBox>

          <GroupBox Grid.Row="2"
                    Style="{StaticResource SettingsSectionGroupBox}">
            <GroupBox.Header>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{DynamicResource Settings.LLM.Parameters}" VerticalAlignment="Center"/>
                <Border Grid.Column="1" Style="{StaticResource HelpIconButton}"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmParameters.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </Grid>
            </GroupBox.Header>
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                  <TextBlock Text="{DynamicResource Settings.LLM.Parameters.MaxToken}" Foreground="{StaticResource TextSecondaryBrush}"/>
                  <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                          ToolTip="{DynamicResource Settings.Tooltip.LlmMaxTokens.Example}">
                    <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                  </Border>
                </StackPanel>
                <Grid Grid.Column="1">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <TextBox x:Name="LlmMaxTokensTextBox"
                           Grid.Column="0"
                           Width="80"
                           Text="{DynamicResource Settings.LLM.Parameters.MaxToken.Default}"
                           TextChanged="OnSettingChanged"/>
                  <TextBlock Grid.Column="1"
                             Text="{DynamicResource Settings.LLM.MaxTokensHint}"
                             FontSize="{StaticResource FontSizeS}"
                             Foreground="{StaticResource TextMutedBrush}"
                             Margin="8,0,0,0"/>
                </Grid>
              </Grid>

              <Grid Grid.Row="1"
                    Margin="{StaticResource LabelMarginTop}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                  <TextBlock Text="{DynamicResource Settings.LLM.Parameters.Temperature}" Foreground="{StaticResource TextSecondaryBrush}"/>
                  <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                          ToolTip="{DynamicResource Settings.Tooltip.LlmTemperature.Example}">
                    <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                  </Border>
                </StackPanel>
                <Grid Grid.Column="1">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <Slider x:Name="LlmTemperatureSlider"
                          Grid.Column="0"
                          Width="160"
                          Minimum="0"
                          Maximum="1"
                          Value="0.3"
                          TickFrequency="0.1"
                          IsSnapToTickEnabled="True"
                          ValueChanged="LlmTemperatureSlider_ValueChanged"/>
                  <TextBlock x:Name="LlmTemperatureValueText"
                             Grid.Column="1"
                             Margin="8,0,0,0"
                             Width="40"
                             HorizontalAlignment="Left"
                             Text="{DynamicResource Settings.LLM.Parameters.Temperature.Default}"/>
                </Grid>
              </Grid>
            </Grid>
          </GroupBox>
        </Grid>

        <Grid Grid.Column="2">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="{StaticResource SpacingM}"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <GroupBox Grid.Row="0"
                    Style="{StaticResource SettingsSectionGroupBox}">
            <GroupBox.Header>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{DynamicResource Settings.LLM.Prompts}" VerticalAlignment="Center"/>
                <Border Grid.Column="1" Style="{StaticResource HelpIconButton}"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmPrompts.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </Grid>
            </GroupBox.Header>
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <StackPanel Grid.Row="0" Orientation="Horizontal">
                <TextBlock Text="{DynamicResource Settings.LLM.Prompts.Title}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmTitlePrompt.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <TextBox Grid.Row="1"
                       x:Name="LlmTitleCustomPromptTextBox"
                       Height="60"
                       TextWrapping="Wrap"
                       AcceptsReturn="True"
                       VerticalScrollBarVisibility="Auto"
                       TextChanged="OnSettingChanged"/>

              <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="{StaticResource LabelMarginTop}">
                <TextBlock Text="{DynamicResource Settings.LLM.Prompts.Description}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmDescriptionPrompt.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <TextBox Grid.Row="3"
                       x:Name="LlmDescriptionCustomPromptTextBox"
                       Height="60"
                       TextWrapping="Wrap"
                       AcceptsReturn="True"
                       VerticalScrollBarVisibility="Auto"
                       TextChanged="OnSettingChanged"/>

              <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="{StaticResource LabelMarginTop}">
                <TextBlock Text="{DynamicResource Settings.LLM.Prompts.Tags}"
                           FontSize="{StaticResource FontSizeS}"
                           Foreground="{StaticResource TextMutedBrush}"/>
                <Border Style="{StaticResource HelpIconButton}" Margin="4,0,0,0"
                        ToolTip="{DynamicResource Settings.Tooltip.LlmTagsPrompt.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </StackPanel>
              <TextBox Grid.Row="5"
                       x:Name="LlmTagsCustomPromptTextBox"
                       Height="60"
                       TextWrapping="Wrap"
                       AcceptsReturn="True"
                       VerticalScrollBarVisibility="Auto"
                       TextChanged="OnSettingChanged"/>
            </Grid>
          </GroupBox>

          <GroupBox Grid.Row="2"
                    Style="{StaticResource SettingsSectionGroupBox}">
            <GroupBox.Header>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{DynamicResource Settings.Suggestions.Count}" VerticalAlignment="Center"/>
                <Border Grid.Column="1" Style="{StaticResource HelpIconButton}"
                        ToolTip="{DynamicResource Settings.Tooltip.SuggestionCount.Example}">
                  <TextBlock Style="{StaticResource HelpIconGlyph}"/>
                </Border>
              </Grid>
            </GroupBox.Header>
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>
              <Grid Grid.Row="0"
                    Margin="{StaticResource LabelMarginBottom}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0"
                           Text="{DynamicResource Settings.Suggestions.Title}"
                           Foreground="{StaticResource TextSecondaryBrush}"/>
                <ComboBox Grid.Column="1"
                          x:Name="TitleSuggestionCountComboBox"
                          Width="120"
                          ItemsSource="{StaticResource SuggestionCountOptions}"
                          SelectionChanged="OnComboBoxSettingChanged"/>
              </Grid>

              <Grid Grid.Row="1"
                    Margin="{StaticResource LabelMarginBottom}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0"
                           Text="{DynamicResource Settings.Suggestions.Description}"
                           Foreground="{StaticResource TextSecondaryBrush}"/>
                <ComboBox Grid.Column="1"
                          x:Name="DescriptionSuggestionCountComboBox"
                          Width="120"
                          ItemsSource="{StaticResource SuggestionCountOptions}"
                          SelectionChanged="OnComboBoxSettingChanged"/>
              </Grid>

              <Grid Grid.Row="2">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0"
                           Text="{DynamicResource Settings.Suggestions.Tags}"
                           Foreground="{StaticResource TextSecondaryBrush}"/>
                <ComboBox Grid.Column="1"
                          x:Name="TagsSuggestionCountComboBox"
                          Width="120"
                          ItemsSource="{StaticResource SuggestionCountOptions}"
                          SelectionChanged="OnComboBoxSettingChanged"/>
              </Grid>
            </Grid>
          </GroupBox>
        </Grid>
      </Grid>
    </ScrollViewer>
  </Grid>
</UserControl>

